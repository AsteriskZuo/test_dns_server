# DNS服务器测试指南

本指南介绍如何全面测试DNS服务器的性能和功能，以评估其是否适合使用。

## DNS测试的关键维度

### 1. 📊 **响应时间和延迟**
DNS查询的响应速度是最重要的性能指标之一：

- **测量方法**: 记录从发送查询到收到响应的时间
- **评估标准**:
  - < 50ms: 优秀
  - 50-100ms: 良好  
  - 100-200ms: 可接受
  - > 200ms: 较慢
- **影响因素**: 地理位置、网络条件、服务器负载

### 2. 🔧 **可用性和可靠性**
DNS服务器必须稳定可靠：

- **在线时间**: 服务器可用性百分比
- **查询成功率**: 成功解析的查询比例
- **故障恢复**: 服务中断后的恢复能力
- **负载处理**: 高并发查询时的性能表现

### 3. ✅ **解析准确性**
确保DNS返回正确的解析结果：

- **结果正确性**: 与权威DNS服务器对比
- **缓存一致性**: 缓存更新的及时性
- **TTL遵循**: 是否正确处理生存时间

### 4. 🌐 **功能支持**
现代DNS服务器应支持多种记录类型和协议：

- **记录类型**: A、AAAA、MX、CNAME、TXT、NS等
- **IPv6支持**: AAAA记录解析
- **EDNS支持**: 扩展DNS功能
- **国际化域名**: 支持非ASCII域名

### 5. 🔒 **安全性**
DNS安全功能越来越重要：

- **DNS over HTTPS (DoH)**: 加密的HTTP传输
- **DNS over TLS (DoT)**: 加密的TLS传输
- **DNSSEC**: 数字签名验证
- **查询隐私**: 不记录用户查询

### 6. 🛡️ **过滤和保护功能**
某些DNS服务提供额外的安全保护：

- **恶意软件过滤**: 阻止恶意网站
- **钓鱼防护**: 识别和阻止钓鱼网站
- **广告屏蔽**: 过滤广告域名
- **家长控制**: 内容分类过滤

### 7. 🌍 **地理位置影响**
不同地理位置的性能差异：

- **就近访问**: 选择地理位置较近的服务器
- **CDN支持**: 内容分发网络优化
- **国际访问**: 跨国网站的解析速度

## 测试工具使用方法

### 基础DNS测试脚本 (`test_dns.sh`)

```bash
# 测试默认DNS服务器
./tools/test_dns.sh

# 测试特定DNS服务器
./tools/test_dns.sh 8.8.8.8 1.1.1.1

# 查看帮助
./tools/test_dns.sh -h
```

**测试内容**:
- 基本连通性测试
- 响应时间测量
- 记录类型支持
- DNSSEC检测
- 过滤功能测试

### 高级DNS测试脚本 (`test_dns_advanced.sh`)

```bash
# 基本测试
./tools/test_dns_advanced.sh

# 详细测试（20次迭代，详细输出）
./tools/test_dns_advanced.sh -c 20 -v

# 全功能测试（包含DoH和IPv6）
./tools/test_dns_advanced.sh --all-tests

# 测试特定服务器并保存结果
./tools/test_dns_advanced.sh -o dns_results.txt 8.8.8.8 1.1.1.1

# 高并发测试
./tools/test_dns_advanced.sh -c 50 -p 10 --doh --ipv6
```

**高级功能**:
- 统计分析（平均值、中位数、最大值）
- 故障率计算
- DNS over HTTPS测试
- IPv6解析测试
- 结果保存和日志记录

### 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `-c, --count` | 每个域名的测试次数 | 10 |
| `-t, --timeout` | 查询超时时间（秒） | 5 |
| `-p, --parallel` | 并发请求数 | 5 |
| `-o, --output` | 保存结果到文件 | 无 |
| `-v, --verbose` | 详细输出 | 关闭 |
| `--doh` | 测试DNS over HTTPS | 关闭 |
| `--ipv6` | 测试IPv6解析 | 关闭 |
| `--all-tests` | 启用所有高级测试 | 关闭 |

## 推荐的DNS服务器

### 公共DNS服务器对比

| 服务商 | 主DNS | 备DNS | 特点 |
|--------|-------|-------|------|
| Google | 8.8.8.8 | 8.8.4.4 | 速度快，全球覆盖 |
| Cloudflare | 1.1.1.1 | 1.0.0.1 | 隐私保护，速度优秀 |
| Quad9 | 9.9.9.9 | 149.112.112.112 | 安全过滤，恶意软件防护 |
| OpenDNS | 208.67.222.222 | 208.67.220.220 | 家长控制，内容过滤 |
| 阿里DNS | 223.5.5.5 | 223.6.6.6 | 国内优化 |
| 腾讯DNS | 119.29.29.29 | 182.254.116.116 | 国内优化 |

### 选择建议

1. **普通用户**: Google DNS (8.8.8.8) 或 Cloudflare (1.1.1.1)
2. **注重隐私**: Cloudflare (1.1.1.1)
3. **需要安全过滤**: Quad9 (9.9.9.9)
4. **企业用户**: OpenDNS
5. **中国大陆用户**: 阿里DNS (223.5.5.5) 或 腾讯DNS (119.29.29.29)

## 测试结果解读

### 性能指标

```
Average: 45.2ms     # 平均响应时间
Median: 42ms        # 中位数响应时间  
Maximum: 156ms      # 最大响应时间
Failure Rate: 2%    # 失败率
```

### 状态符号

- ✓ (绿色): 功能正常工作
- ! (黄色): 功能不可用或未检测到
- ✗ (红色): 功能失败或服务器不可达

### 性能评级

- **Excellent** (< 50ms): 响应极快，用户体验优秀
- **Good** (50-100ms): 响应良好，适合大多数用途
- **Acceptable** (100-200ms): 响应可接受，可能有轻微延迟
- **Poor** (> 200ms): 响应较慢，建议更换DNS服务器

## 故障排查

### 常见问题

1. **DNS解析失败**
   - 检查网络连接
   - 验证DNS服务器地址
   - 尝试其他DNS服务器

2. **响应时间过长**
   - 测试多个DNS服务器进行对比
   - 检查网络延迟
   - 考虑地理位置因素

3. **某些网站无法访问**
   - 检查DNS过滤设置
   - 尝试不同的DNS服务器
   - 验证域名是否存在

### 优化建议

1. **使用多个DNS服务器**: 配置主备DNS
2. **就近选择**: 优先选择地理位置较近的服务器
3. **定期测试**: 定期评估DNS性能
4. **缓存优化**: 合理配置本地DNS缓存

## 自动化监控

可以将测试脚本集成到监控系统中：

```bash
# 定期测试脚本（添加到crontab）
0 */6 * * * /path/to/test_dns_advanced.sh -o /var/log/dns_test.log

# 简单的监控脚本
#!/bin/bash
THRESHOLD=100  # 100ms阈值
RESULT=$(./tools/test_dns_advanced.sh 8.8.8.8 | grep "Average:" | awk '{print $2}' | sed 's/ms//')
if (( $(echo "$RESULT > $THRESHOLD" | bc -l) )); then
    echo "DNS响应时间过长: ${RESULT}ms" | mail -s "DNS监控告警" admin@example.com
fi
```

这样你就可以全面测试和监控DNS服务器的性能了！ 